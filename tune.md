Прошивка, настройка и калибровка.
===


Настройка драйверов.
---

Первым делом после сборки схемы необходимо выставить ограничение тока шаговых двигателей.
Это делается при первом включении. Проще всего это сделать при помощи измерения напряжения на подстроечном резисторе, которым собственно и ограничивается ток. Формула для драйвера DRV8825 такая: ``` Imax = 2 * Vref ```
Если используются шаговые двигатели с током обмоток 0.6А, то подстроечный резистор необходимо накрутить так, чтобы на нем было напряжение 0.3В

![Image](https://raw.githubusercontent.com/minsk-hackerspace/Robbal/master/images/DSC_9034_1.jpg)

Более подробная стастья по настройке [тут](https://www.pololu.com/product/1182)

Прошивка.
---

В прошивке Arduino нет ничего необычного
Скачивается [скетч для Arduino](https://github.com/minsk-hackerspace/Robbal/blob/master/robbal/robbal.ino)
И прошивается самым [обычным способом](https://www.arduino.cc/en/Guide/ArduinoProMini), через UART переходник.

*Важно* Если в собранной конструкции робота вертикально расположена ось Y гироскопа в скетче должна присутствовать строчка
```#define flipXY``` 
Если вертикально расположена ось Х гироскопа то эту строчку следует закомментировать или убрать.

Бывает так что Arduino IDE не может прошить Arduino и отваливается с ошибкой "avrdude: stk500_getsync(): not in sync" Это распростаненная проблема когда есть проблемы с драйверами или UART или bootloader-ом в ардуине. Лечится кучей разных способов. Можно просто попробовать нажать кнопку reset на плате Arduino в момент начала прошивки. (нажать upload в Arduino IDE и через секунду reset на самой Arduino)

Прошивка работает таким образом:
При включении робот выводит в Serial ```hello balancing robot``` и начинает калибровку. ```Calibration...``` При этом робот должен лежать так, чтобы ось Z акселерометра была направлена вверх. Так проходит несколько секунд, за это время высчитваются дрейфы по осям X и Y, и робот быстро моргает светодиодом на ардуине. После калибровки в в Serial выводится ```Calibration Done``` робот моргает свтодиодом раз в секунду и ждет чтобы его подняли до почти вертикального положения. В вертикальном положении робот включается пишет ``` start ``` и подхватывает свой вес.

__ Serial порт работает на скорости 115200 бод. __

Калибровка вертикали (точки баланса)
---

После прошивки скетча рекомендуется отсоеденить моторы и выставить точку баланса.
Не всегда после сборки вертикальная ось получается строго вертикально. На это влиеет установка компонентов внутрь корпуса, их развесовка и даже распайка чипа на саму плату.

Для этого нужно отсоединить моторы и запустить робота с подключенным кабелеи UART и включенным Serial Monotir. После запуска, калибровки и старта В Serial Monitor время от времени робот реортит свой угол в двух значениях: сырые данные ```accelerometer_data_raw XXX``` и высчитаное значение в градусах ```angle X```

Поднимая робота так, чтобы он практически стоял под своим весом и никуда не отклонялся следим за выводимым значением ```accelerometer_data_raw XXX``` Затем в прошивке в значение ```acc_calibration_value``` необходимо выставить обратное значение и перепрошить робота.

Другими словами необходимо подобрать переменную ```acc_calibration_value``` таким образом чтобы при вертикальном положении значение ```accelerometer_data_raw``` было близко к нулю. Связяны эти значения по такой формуле ```  accelerometer_data_raw = accelerometer_data_read + acc_calibration_value; ``` где ```accelerometer_data_read``` это значение полученное с акселерометра а ```accelerometer_data_raw``` это значение используемое для расчетов, в абсолютно вертикальном положении там должен быть ноль.


Правильное подключение моторов.
---
При правильном подключении моторов они должны вращатся в ту же сторону куда наклоняется робот от вертикального положения и чем сильнее наклон тем быстрее вращение. Ничего сложного в этом нет и все должно работать практически сразу. Когда что-то работает не так - то есть наксолько симптомов и их решения:

- Моторы пищат, но не крутятся

В этом случае либо они не правильно подключены к драйверам, либо неправильно выставлен ток или микростеппинг.
Подключение должно быть парами проводов к парам выводам драйвера A и B. Обычно это синий+желтый и красный+сезеный.
Ток должен быть таким чобы не превышать максимально допустимый для моторов, но при этом не слишком малым чтобы мог вращать колеса с достаточным усилием. Микрошаг должен быть 1/4 1/2 иногда можно даже 1. Чем полнее шаг - тем быстрее могут крутиться колеса, но при этом падает плавность и при резких стартах могут начаться пропуски шагов.

- Моторы крутятся в разные стороны.

Необходимо на одном из моторов перевернуть обмотки А/Б

- Моторы крутятся не в ту сторону.

Необходимо поменять моторы местами.

- Моторы начинают крурутится только при наклоне в стороны, вместо наклона взад/перед.

Неправильно определены оси, ```#define flipXY``` в прошивке.


Калибровка PID
---

Колибровка PID регулятора это самое интересное. Кто лучше подберет значения PID тот победит.
ПИД это Пропорционально Интегрально Диференциальный. В нем эти три составляющие и соответственно три коэффициента.
Есть множество способов расчета этих коэффициантов, но ниже описан только метод ручного подбора.


To be continued...
